# 🏗️ 3D 模型管理系統架構圖

## 系統總覽

```
┌─────────────────────────────────────────────────────────────────┐
│                         使用者介面層                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ ModelViewer  │  │ModelSelector │  │ DynamicRobotArm      │  │
│  │ （檢視器）    │  │ （選擇器）    │  │ （動態機器人手臂）   │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        React Hooks 層                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  useModel()          - 載入單一模型                       │  │
│  │  useModelsList()     - 載入模型清單（分頁）               │  │
│  │  useModelsByCategory() - 類別篩選                        │  │
│  │  useModelPreload()   - 預載模型                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                       業務邏輯層                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  loadModel()         - 自動偵測格式並載入               │    │
│  │  loadGLBModel()      - 載入 GLB 格式                   │    │
│  │  loadGLTFModel()     - 載入 GLTF 格式                  │    │
│  │  createGLTFBlobURL() - 建立 GLTF Blob URL              │    │
│  │  revokeBlobURL()     - 釋放 Blob URL                   │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
              ↓                                   ↓
┌─────────────────────────┐         ┌──────────────────────────┐
│      API 服務層          │         │   IndexedDB 管理層       │
│  ┌──────────────────┐   │         │  ┌──────────────────┐   │
│  │  ModelService    │   │         │  │  modelIndexedDB  │   │
│  │                  │   │         │  │                  │   │
│  │ • getModelsList  │   │         │  │ • saveGLBModel   │   │
│  │ • getModelDetail │   │         │  │ • saveGLTFModel  │   │
│  │ • downloadGLB    │   │         │  │ • getModel       │   │
│  │ • getGLTFJson    │   │         │  │ • deleteModel    │   │
│  │ • downloadResource│  │         │  │ • clearAllModels │   │
│  └──────────────────┘   │         │  │ • getCacheSize   │   │
└─────────────────────────┘         │  └──────────────────┘   │
              ↓                     └──────────────────────────┘
┌─────────────────────────┐                     ↓
│     後端 API 伺服器      │         ┌──────────────────────────┐
│                         │         │    瀏覽器 IndexedDB       │
│  /api/models           │         │                          │
│  /api/models/:id       │         │  Database: VisualFlow3D  │
│  /api/models/:id/gltf  │         │  Store: models           │
│  /api/models/:id/      │         │  Indexes:                │
│    download            │         │  - format                │
│  /api/models/:id/      │         │  - version               │
│    resources/:filename │         │  - cachedAt              │
└─────────────────────────┘         └──────────────────────────┘
```

## 資料流程

### 📥 載入流程（含快取）

```
開始
  │
  ├─> [useModel Hook]
  │     │
  │     └─> [loadModel]
  │           │
  │           ├─> 1️⃣ 檢查 IndexedDB
  │           │     │
  │           │     ├─ 有快取 & 版本相符 ──> 從快取載入 ──> 建立 Blob URL ──> 完成 ✅
  │           │     │
  │           │     └─ 沒有快取 or 版本不符 ──> 繼續 ↓
  │           │
  │           ├─> 2️⃣ 從 API 下載
  │           │     │
  │           │     ├─ GLB: 下載單一檔案
  │           │     └─ GLTF: 下載 JSON + 並行下載所有資源
  │           │
  │           ├─> 3️⃣ 儲存到 IndexedDB
  │           │
  │           └─> 4️⃣ 建立 Blob URL ──> 完成 ✅
  │
結束
```

### 🔄 快取策略

```
┌────────────────────────────────────────┐
│         第一次載入（無快取）             │
├────────────────────────────────────────┤
│ 1. 從 API 下載模型                      │
│ 2. 儲存到 IndexedDB                     │
│ 3. 建立 Blob URL                       │
│ 4. 載入時間: ~2-5 秒 ⏱️                │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│       第二次載入（有快取）               │
├────────────────────────────────────────┤
│ 1. 從 IndexedDB 讀取                    │
│ 2. 建立 Blob URL                       │
│ 3. 載入時間: ~0.1-0.5 秒 ⚡            │
└────────────────────────────────────────┘
```

## 檔案組織

```
front-end/
├── src/
│   ├── types/
│   │   └── model.ts ················· 型別定義
│   │
│   ├── lib/
│   │   ├── modelIndexedDB.ts ········ IndexedDB 管理
│   │   └── modelLoader.ts ··········· 模型載入邏輯
│   │
│   ├── services/
│   │   └── ModelService.ts ·········· API 服務
│   │
│   ├── hooks/
│   │   └── useModel.ts ·············· React Hooks
│   │
│   ├── features/robot-sim/components/
│   │   ├── ModelViewer.tsx ·········· 檢視器元件
│   │   ├── ModelSelector.tsx ········ 選擇器元件
│   │   └── DynamicRobotArm.tsx ······ 動態機器人元件
│   │
│   └── app/
│       └── model-demo/
│           └── page.tsx ············· 示範頁面
│
└── docs/
    ├── 3D_MODEL_SYSTEM.md ··········· 完整文件
    ├── IMPLEMENTATION_SUMMARY.md ···· 實作總結
    ├── QUICK_START.md ··············· 快速開始
    └── ARCHITECTURE.md ·············· 本文件
```

## API 設計

```
┌──────────────────────────────────────────────────────┐
│                    後端 API                           │
├──────────────────────────────────────────────────────┤
│                                                       │
│  GET  /api/models                                    │
│       ↳ 取得模型清單（分頁、搜尋、類別篩選）           │
│                                                       │
│  GET  /api/models/:id                                │
│       ↳ 取得模型詳細資訊                              │
│                                                       │
│  GET  /api/models/:id/download                       │
│       ↳ 下載 GLB 檔案                                │
│                                                       │
│  GET  /api/models/:id/gltf                           │
│       ↳ 取得 GLTF JSON                               │
│                                                       │
│  GET  /api/models/:id/resources/:filename            │
│       ↳ 下載資源檔案（.bin、貼圖）                    │
│                                                       │
│  GET  /api/models/:id/thumbnail                      │
│       ↳ 下載縮圖                                      │
│                                                       │
│  HEAD /api/models/:id/download                       │
│       ↳ 檢查版本（不下載內容）                        │
│                                                       │
└──────────────────────────────────────────────────────┘
```

## IndexedDB 結構

```
┌──────────────────────────────────────────────────────┐
│  Database: VisualFlow3DModels (version 1)            │
├──────────────────────────────────────────────────────┤
│                                                       │
│  ObjectStore: models                                 │
│  KeyPath: modelId                                    │
│                                                       │
│  Indexes:                                            │
│  • format (glb/gltf)                                 │
│  • version (版本號)                                  │
│  • cachedAt (快取時間)                               │
│                                                       │
│  ┌────────────────────────────────────────────────┐ │
│  │ Record 範例 (GLB):                             │ │
│  │ {                                              │ │
│  │   modelId: "robot-arm-001",                    │ │
│  │   format: "glb",                               │ │
│  │   version: "1.2.0",                            │ │
│  │   file: Blob,                                  │ │
│  │   metadata: {                                  │ │
│  │     name: "Gardener Robot Arm",                │ │
│  │     fileSize: 2048576,                         │ │
│  │     cachedAt: 1737519585000                    │ │
│  │   }                                            │ │
│  │ }                                              │ │
│  └────────────────────────────────────────────────┘ │
│                                                       │
│  ┌────────────────────────────────────────────────┐ │
│  │ Record 範例 (GLTF):                            │ │
│  │ {                                              │ │
│  │   modelId: "robot-arm-002",                    │ │
│  │   format: "gltf",                              │ │
│  │   version: "1.0.0",                            │ │
│  │   gltf: { /* JSON */ },                        │ │
│  │   resources: {                                 │ │
│  │     "geometry.bin": Blob,                      │ │
│  │     "texture.png": Blob                        │ │
│  │   },                                           │ │
│  │   metadata: { ... }                            │ │
│  │ }                                              │ │
│  └────────────────────────────────────────────────┘ │
│                                                       │
└──────────────────────────────────────────────────────┘
```

## 使用範例對照

### 靜態載入（舊方式）
```tsx
// ❌ 固定路徑，無快取，無法動態切換
const { scene } = useGLTF('/models/robot.glb');
```

### 動態載入（新方式）
```tsx
// ✅ 動態載入，自動快取，支援多模型
const { model } = useModel('robot-arm-001');
if (model) {
    const { scene } = useGLTF(model.url);
}
```

## 效能優化

```
┌─────────────────────────────────────────────────┐
│             快取命中率優化                       │
├─────────────────────────────────────────────────┤
│                                                  │
│  1. 版本控制 ··················· ETag           │
│  2. 長期快取 ··················· immutable      │
│  3. 並行下載 ··················· Promise.all   │
│  4. 漸進式載入 ················· 先 JSON 後資源 │
│  5. 記憶體管理 ················· Blob URL 清理 │
│  6. 過期清理 ··················· LRU 策略       │
│                                                  │
└─────────────────────────────────────────────────┘
```

## 總結

這個系統提供了：

✅ **簡單易用** - 只需一個 Hook  
✅ **自動快取** - IndexedDB 自動管理  
✅ **高效能** - 並行下載 + 長期快取  
✅ **靈活** - 支援 GLB 和 GLTF  
✅ **可靠** - 完整的錯誤處理  
✅ **可維護** - 清晰的架構分層  

查看 [快速開始](./QUICK_START.md) 了解如何使用！
